# RID Hijacking (Defensive Notes)

## TL;DR
- RIDはユーザー識別（SID末尾）に関わり、ログオン時にトークン生成へ影響する。
- 攻撃では「RID/関連情報の改ざん」で、権限の誤付与を狙う可能性がある。
- 防御は「SAM/LSASS周辺への不審アクセス」「レジストリ改変」「特権トークンの異常」を見る。

## Why it matters
Windowsでは、ログオン時に認証情報やSID/RIDをもとにアクセストークンが生成される。
ここに関わる領域（SAM、LSASS、関連レジストリ）が不正に操作されると、権限の整合性が崩れるリスクがある。

## Concepts
- RID：SID末尾の数値（ユーザー識別の一部）
- LSASS：認証/トークン生成に関わるプロセス
- SAM：ローカルアカウント情報に関わる領域（強い保護が前提）

## Telemetry / Detection ideas
### 監視したい兆候
- SAM/LSASS関連への不審アクセス（ダンプ・読み取り・保護回避）
- レジストリ値の変更（特にアカウント関連・セキュリティ関連のキー）
- “SYSTEM相当の操作”を可能にするツール/実行形跡（正規でも悪用されうる）

### 見るログの例
- レジストリ変更監査（Registry value set / modified）
- プロセス生成（管理ツールやリモート実行系の起動）
- 特権ログオン（高権限トークンを示すログ）との相関

## Triage checklist (SOC L1)
1. 変更（疑い）の起点：どのホストで、いつ、何が変わった？
2. 実行者：誰が実行した？（通常運用者か）
3. プロセス：どんなプロセスがレジストリ/資格情報領域へアクセスした？
4. 直後の挙動：権限が増えた兆候（管理操作、サービス作成、横展開など）
5. 影響範囲：同一ユーザー/同一ホストで類似の変更が連鎖していないか

## Hardening / Prevention
- LSASS保護（RunAsPPL等）、Credential Guard等の防御機能を検討
- SAM/セキュリティ関連への監査を有効化し、SIEMで相関
- 管理権限の濫用を抑制（PAM/JIT、不要なローカル管理者削減）
- EDRで資格情報アクセス・レジストリ改ざんのルールを強化

## Notes (what I learned)
- “認証やトークン生成に関わる場所”は、攻撃者にとって最重要の改変対象になりうる。
- 監視は「単発イベント」よりも「変更→特権行動」の連鎖で見ると判断しやすい。
